# 线上诊断Tomcat的问题-工具与方法

本篇主要讲解一些介绍`Tomcat`线上问题诊断方法，以及诊断工具的使用。每一个问题场景下都有自己的问题，本篇只是介绍收集线上问题的一般步骤与排查的套路。

-----------


## 一、工具箱介绍

目前笔者使用过的有成功案例的工具主要是`JDK`本身还有就是`MemoryAnalyzer`前者主要是收集以及查看线上JVM的信息，后者主要是对JVM的内存进行分析。

### 1.1、 JDK自带的工具 

在JDK中官方原生就提供了很多的工具给我们获取到正在运行的JVM状态的工具，由于线上的系统使用的JRE，所以在使用是需要我们先在线上的环境上配置JDK，如果是Linux的系统其实只要在当前Shell中
export变量即可，使用完成后再删掉JDK即可，如果是Windows，自求多福，再`cmd.exe(使用对应的JVM启动用户身份运行)`中使用`set`命令临时添加即可，但是笔者在有的项目上实验有事会不成功。
在JDK的工具中，笔者尝试用到的命令主要是`jps`、`jmap`、`jstack`、`jinfo`、`jstat`，当然还有一些可视化的工具辅助我们进行查看，比如`jvisualvm`和`jmc(java飞行记录器，这个也是JDK后来的推出的工具)`
这些可视化的工具都需要重启JVM，所以一般情况下笔者很少使用，或者问题发现很频繁的话可以开启调试一下。


对该[工具的使用说明可以官网上获取到](https://docs.oracle.com/javase/7/docs/technotes/tools/)




### 1.2、 MemoryAnalyzer

该工具主要是对内存快照文件进行分析，该工具会是自动的协助我们，找到内存上占用量比较大的对象以及问题。工具可以从[此处下载到](http://fdoc.epoint.com.cn:3366/eclipse/MemoryAnalyzer-1.7.0.20170613-win32.win32.x86_64.zip)，
通过该工具我们可以查看到当前的JVM堆栈中大对象以及线程信息等等。


## 二、明确目标

在诊断问题前，先要明确问题，你要查找的问题是`CPU`问题还是`内存`问题，如果是内存问题则首选的方法先让系统跑一段时间，然后等待使用内存飙升上去了之后打出一个内存快照出来，使用`MemoryAnalyzer`进行分析即可，如果是调试`CPU`或者线程阻塞的问题的，则倾向于使用`jstack`的方法，打出当前运行的堆栈快照。查看线程状态为`WAITTING`或者`LOCKED`的即可。工具方法有很多种，但是思路(套路)是最重要的。




## 三、 调试线程阻塞或者CPU过高的问题

对于`CPU`问题通常情况下，我们应该很容易可以复现的，所以我们可以直接在`JVM`的启动参数中加入`-Dcom.sun.management.jmxremote.port=8888 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false  -Djava.rmi.server.hostname=192.168.1.51`，加入该段参数后`JVM`会在本机的`8888`端口上启动一个监听，我们可以使用`JMX`工具连接进来查看与诊断问题。


## 四、 调试内存问题



对于`内存`问题一般我们会使用先使用压力测试工具，或者其他手段将内存撑满，先还原现象，在使用`jmap`工具将`JVM`内存进行`DUMP`出来，使用`MemoryAnalyzer`工具对内存文件进行分析，我们以某一个项目上的具体为题为例子，阐述如何使用该工具，首先站在全局的角度来介绍一下`MemoryAnalyzer`的功能与基本使用方法。首先打开堆快照文件，工具会自动分析技术快照内的类对象数量。

![](https://github.com/liuwenru/tomcat7.0.82-codeview/blob/master/docs/images/jdktools/MemoryAnalyzerIntro.png)


如上图所示，`MemoryAnalyzer`工具为我们提供了几个功能



- `Overview:` 是一个总的分析预览，其中我们比较感兴趣的是中间的饼图，我们可以快速的知道当前的堆中有那些比较大的对象。
- `Histogram:` 该视图是按照类名称将每一个类在堆中占用的大小统计出来
- `thread_overview:` 该视图显示的是在执行堆栈快照时运行的线程状态，一般情况下我们可以在里面找到我们的业务程序代码，但是你找快照的时候巧了都是在执行`Tomcat`的代码，你可以在多照几次，不要觉得都是`Tomcat`代码就不是你的问题
- `dominator_tree:` 该视图提供堆栈中按照对象进行划分，我们在这个视图里面可以查看到每一类对象的大小占比。

该页面中暂时我们比较关心的内容大致如上，实际在分析的时候往往是在多个视图之间进行对比与查看才能够得出结论。


































































